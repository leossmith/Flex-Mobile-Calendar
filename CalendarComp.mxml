<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 creationComplete="initView(event)">
	
	<fx:Metadata>
		[Event(name="dateSelectedEvent", type="events.RefreshEvent")]
	</fx:Metadata>
	
	<fx:Script>
		<![CDATA[
			import mx.collections.ArrayCollection;
			import mx.collections.ArrayList;
			import mx.events.FlexEvent;
			
			import classes.ReturnMonthName;
			import classes.colors;
			
			import events.RefreshEvent;
			
			import views.bookings.bookingsView;
			
			private var fisrtDayStr:int;
			private var lastDayStr:int;
			private var thisMonth:int;
			private var thisYear:int;
			[Bindable]
			private var monthLabelString:String;
			private var currentYear:int;
			private var currentMonth:int;
			private var currentDay:int;
			private var maxItems:int = 35;
			
			private var getMonthClass:ReturnMonthName = new ReturnMonthName;
			private var arrMonthCal:ArrayCollection = new ArrayCollection;
			private var arrMonthCal1:ArrayCollection = new ArrayCollection;
			private var arrThisMonth:ArrayCollection = new ArrayCollection;
			
			public var endDates:mx.collections.ArrayList;
			
			
			protected function initView(event:FlexEvent):void {
				var currentDate:Date = new Date();
			
				var currentDayNum:int = currentDate.date;
				var currentDayStr:int = currentDate.day;
				currentDay = currentDayNum;
				currentMonth = thisMonth = currentDate.month;
				currentYear = thisYear = currentDate.fullYear;
				
				for (var i:int = currentDayNum; i > 1; i--) {
					currentDayStr--;
					if (currentDayStr < 0) {
						currentDayStr = 6;
					}
				}
				fisrtDayStr = currentDayStr;
				addEventListener(TransformGestureEvent.GESTURE_SWIPE, onSwipe);	
				/*db = File.applicationStorageDirectory.resolvePath("Tourismart.db");
				conn = new SQLConnection();
				conn.addEventListener(SQLEvent.OPEN, openDatabaseHandler);
				conn.openAsync(db);*/
				changeMonthLabel(thisMonth, thisYear);
			}
			
			protected function onSwipe(event:TransformGestureEvent):void {
				if (event.offsetX == -1) {
					goNext();
					
				} 
				else if (event.offsetX == 1) {
					goPrevious();
				}
			}
				
			protected function goToPreviousMonth(event:MouseEvent):void {
				goPrevious();
			}
			
			private function goPrevious():void {
				thisMonth--;
				if (thisMonth < 0) {
					thisMonth = 11;
					thisYear--;
				}
				groupLayout.removeAllElements();
				
				var lastDay:int;
				if (fisrtDayStr - 1 >= 0) {
					lastDay = fisrtDayStr - 1;
				}
				else {	
					lastDay = 6;
				}
				changeMonthLabel(thisMonth, thisYear);
				changePreviousCalendar(lastDay, thisMonth, thisYear);
			}
			
			protected function goToNextMonth(event:MouseEvent):void {
				goNext();
			}
			
			private function goNext():void {
				thisMonth++;
				if (thisMonth > 11) {
					thisMonth = 0;
					thisYear++;
				}
				fisrtDayStr = lastDayStr + 1;
				groupLayout.removeAllElements();
				changeMonthLabel(thisMonth, thisYear);
				changeCurrentNextCalendar(fisrtDayStr, thisMonth, thisYear);
			}
	
			protected function changePreviousCalendar(lastDay:int, month:int, year:int):void {
				var currentDayNum:int = getDayCount(year, month+1);
				var currentDayStr:int = lastDay;
				for (var i:int = currentDayNum; i > 1; i--) {
					currentDayStr--;
					if (currentDayStr < 0) {
						currentDayStr = 6;
					}
				}
				fisrtDayStr = currentDayStr;
				
				changeCurrentNextCalendar(fisrtDayStr, month, year);
			}
			
		/*	public function lol():void{
				myStatement = new SQLStatement();
				myStatement.sqlConnection = conn;
				myStatement.addEventListener(SQLEvent.RESULT, distinctFromBookingResults);				
				myQuery = "SELECT DISTINCT start_date FROM booking";
				myStatement.text = myQuery;
				myStatement.execute();
				
			}*/
			
			
			public function changeCurrentNextCalendar(firstDay:int, month:int, year:int):void {
				arrThisMonth.removeAll();
				var previousMonthMaxDays:int = getDayCount(year, month);
				previousMonthMaxDays = previousMonthMaxDays - (firstDay - 1);
				var isAdded:Boolean = false;
				arrMonthCal.removeAll();
				arrMonthCal1.removeAll();
				groupLayout.removeAllElements();
				//if(startDates!=null){
				for (var o:int = 0; o < endDates.length; o++) {
					var startDate:String = String(endDates.getItemAt(o).start_date);
					if (int(startDate.substr(5,2))-1 == month && int(startDate.substr(0,4)) == year) {
						arrMonthCal1.addItem({day:int(startDate.substr(8,2))});
					}
				}
				//}
				//if(endDates!=null){
				for (var o:int = 0; o < endDates.length; o++) {
					var arrDate:String = String(endDates.getItemAt(o).end_date);
					if (int(arrDate.substr(5,2))-1 == month && int(arrDate.substr(0,4)) == year) {
						arrMonthCal.addItem({day:int(arrDate.substr(8,2))});
					}
				}
				//}
				if (firstDay == 0) {
					firstDay = 7;
					previousMonthMaxDays = previousMonthMaxDays - (firstDay);
				}
				for (var j:int = 0; j < firstDay; j++) {
					/*var previousDayLab:Label = new Label;
					previousDayLab.text = previousMonthMaxDays + "";
					previousDayLab.styleName = "calendarPreviousMonthDay";*/
					var previousDayLab:DateComp = new DateComp;
					previousDayLab.year = thisYear;
					previousDayLab.month = thisMonth;
					previousDayLab.day = previousMonthMaxDays + "";
					previousDayLab.width = tileLayout.columnWidth;
					previousDayLab.height = tileLayout.rowHeight;
					previousDayLab.el.visible = false;
					previousDayLab.ellipse.visible = false;
					previousDayLab.ellipse1.visible = false;
					groupLayout.addElement(previousDayLab);
					previousMonthMaxDays++;
				}
				for (var k:int = 1; k <= getDayCount(year, month + 1); k++) {
					var thisDateComp:DateComp = new DateComp;
					thisDateComp.addEventListener("daySelectedEvent", dateSelected);
					thisDateComp.year = thisYear;
					thisDateComp.month = thisMonth;
					thisDateComp.day = k + "";
					if (currentYear == year && currentMonth == month && currentDay ==  k) {
						thisDateComp.style = "calendarThisMonthDayCurrent";
						thisDateComp.isCurrent = true;
					}
					else {
						thisDateComp.style = "calendarThisMonthDay";
						thisDateComp.isCurrent = false;
					}
					for (var i:int = 0; i < arrMonthCal1.length; i++) {
						
							if (k ==  arrMonthCal1.getItemAt(i).day) {
								thisDateComp.starts = true;
								isAdded = true;
							}
						
					}
					for (var i:int = 0; i < arrMonthCal.length; i++) {
						
							if (k ==  arrMonthCal.getItemAt(i).day) {
								thisDateComp.ends = true;
								isAdded = true;
							}
						
					}
					thisDateComp.width = tileLayout.columnWidth;
					thisDateComp.height = tileLayout.rowHeight;
					arrThisMonth.addItem(thisDateComp);
					groupLayout.addElement(thisDateComp);
					if (k == getDayCount(year, month + 1)) {
						lastDayStr = getDayString(year, month, k);
					}
					isAdded = false;
				}
				var nextMonthDays:int = (firstDay - 1) + getDayCount(year, month + 1);
				for (var l:int = 1; l < (maxItems - nextMonthDays); l++) {
					/*var nextDayLab:Label = new Label;
					nextDayLab.text = l + "";
					nextDayLab.styleName = "calendarPreviousMonthDay";*/
					var nextDayLab:DateComp = new DateComp;
					nextDayLab.year = thisYear;
					nextDayLab.month = thisMonth;
					nextDayLab.day = l + "";
					nextDayLab.width = tileLayout.columnWidth;
					nextDayLab.height = tileLayout.rowHeight;
					nextDayLab.el.visible = false;
					nextDayLab.ellipse.visible = false;
					nextDayLab.ellipse1.visible = false;
					groupLayout.addElement(nextDayLab);
				}
			}
			
			protected function getDayCount(year:int, month:int):int{
				var d:Date = new Date(year, month, 0);
				return d.getDate();
			}
			
			protected function getDayString(year:int, month:int, day:int):int{
				var d:Date = new Date(year, month, day);
				return d.getDay();
			}
			
			protected function dateSelected(e:RefreshEvent):void {
				dispatchEvent(new RefreshEvent('dateSelectedEvent', e.data));
				for (var i:int = 0; i < arrThisMonth.length; i++) {
					if (arrThisMonth.getItemAt(i).day != e.data.day) {
						arrThisMonth.getItemAt(i).label1.setStyle("color",0x000000);
						arrThisMonth.getItemAt(i).label1.setStyle("fontWeight","normal");
						if (arrThisMonth.getItemAt(i).year == currentYear && arrThisMonth.getItemAt(i).month == currentMonth && arrThisMonth.getItemAt(i).day ==  currentDay) {
							arrThisMonth.getItemAt(i).style = "calendarThisMonthDayCurrent";
						}
						else {
							arrThisMonth.getItemAt(i).style = "calendarThisMonthDay";
						}
					}
					else {
						if (arrThisMonth.getItemAt(i).year == currentYear && arrThisMonth.getItemAt(i).month == currentMonth && arrThisMonth.getItemAt(i).day ==  currentDay) {
							arrThisMonth.getItemAt(i).style = "calendarThisMonthDayCurrent";
						}
						else {
							arrThisMonth.getItemAt(i).label1.setStyle("color",0xFFFFFF);
							arrThisMonth.getItemAt(i).label1.setStyle("fontWeight","bold");
						}
					}
				}
				
			}
			
			protected function changeMonthLabel(month:int, year:int):void {
				monthLabelString = getMonthClass.getMonthName(month) + " " + year;
			}
			
			
		]]>
	</fx:Script>	
	
	   <s:Group width="100%" height="{this.height * .15}">
		   <s:Rect width="100%" height="100%">
			   <s:fill>
				   <s:SolidColor color="#3bafda"/>
			   </s:fill>
		   </s:Rect>
		   <s:HGroup width="100%" height="100%" gap="0" verticalAlign="middle" horizontalAlign="center">
			   <s:Group height="100%" click="goToPreviousMonth(event)">
				   <s:Image height="50%" smooth="true" smoothingQuality="high" scaleMode="letterbox" verticalCenter="0" horizontalAlign="right">
					   <s:source>
						   <s:MultiDPIBitmapSource source160dpi="@Embed('assets/buttons/lowRes/back.png')"
												   source240dpi="@Embed('assets/buttons/medRes/back.png')"
												   source320dpi="@Embed('assets/buttons/highRes/back.png')"
												   source480dpi="@Embed('assets/buttons/hdRes/back.png')"/>
					   </s:source>
				   </s:Image>
			   </s:Group>
			   
			   <s:Label text="{monthLabelString}" textAlign="center" width="36%" styleName="calendarMonthComponent"/>
			   <s:Group height="100%" click="goToNextMonth(event)">
				   <s:Image height="50%" smooth="true" smoothingQuality="high" scaleMode="letterbox" verticalCenter="0" horizontalAlign="left">
					   <s:source>
						   <s:MultiDPIBitmapSource source160dpi="@Embed('assets/buttons/lowRes/next.png')"
												   source240dpi="@Embed('assets/buttons/medRes/next.png')"
												   source320dpi="@Embed('assets/buttons/highRes/next.png')"
												   source480dpi="@Embed('assets/buttons/hdRes/next.png')"/>
					   </s:source>
				   </s:Image>
			   </s:Group>
		   </s:HGroup>
	   </s:Group>
	
		<s:Group width="100%" height="{this.height}" top="{this.height * .15}">
			<s:Rect width="100%" height="100%">
				<s:fill>
					<s:SolidColor color="#DEDEDD"/>
				</s:fill>
			</s:Rect>
			
			<s:HGroup width="100%" height="10%" gap="1" verticalAlign="middle" horizontalAlign="center">
				<s:Label text="{resourceManager.getString('resources','CALENDAR_SUNDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_MONDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_TUESDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_WEDNESDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_THURSDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_FRIDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
				<s:Label text="{resourceManager.getString('resources','CALENDAR_SATURDAY')}" textAlign="center" width="{this.width * .14}" styleName="calendarDayComponent"/>
			</s:HGroup>
			
			<s:Group id="groupLayout">
				<s:layout>
					<s:TileLayout  id="tileLayout" paddingTop="{this.height * .1}" columnWidth="{this.width * .14}" rowHeight="{this.height * .13}" verticalGap="0" horizontalGap="1" verticalAlign="middle" horizontalAlign="center" orientation="rows"  requestedColumnCount="7" />
				</s:layout>	
			</s:Group>
		</s:Group>
</s:Group>
